<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSO Docket Review Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF Libraries for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Cambria', 'Cochin', 'Georgia', 'Times', 'Times New Roman', serif;
            background-color: #f7f8fc;
        }
        .custom-shadow {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .fade-in {
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.5);
        }
        .form-select, .form-input, .form-textarea, .form-radio {
            transition: all 0.2s ease-in-out;
        }
        .form-select:focus, .form-input:focus, .form-textarea:focus {
             border-color: #4f46e5;
             box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .review-item.review-complete {
            border-left-color: #10b981;
            background-color: #f0fdf4;
        }
        .review-item.review-in-progress {
             border-left-color: #f59e0b;
             background-color: #fffbeb;
        }
        .review-item:hover {
             transform: translateY(-2px);
             box-shadow: 0 8px 20px rgba(0,0,0,0.07);
        }
        .review-item .review-status-icon {
            display: inline-block;
        }
        .main-tab-btn {
            transition: all 0.2s ease-in-out;
            border-bottom: 3px solid transparent;
        }
        .main-tab-btn.active {
            border-bottom-color: #4f46e5;
            color: #4f46e5;
        }
        details > summary {
            list-style: none;
            cursor: pointer;
            padding: 1rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            font-weight: bold;
            color: #374151;
            transition: background-color 0.2s;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details > summary:hover {
            background-color: #f3f4f6;
        }
        details summary::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            float: right;
            transition: transform 0.2s;
        }
        details[open] summary::after {
            transform: rotate(180deg);
        }
        details[open] > summary {
            background-color: #f3f4f6;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .accordion-content {
            border: 1px solid #e5e7eb;
            border-top: none;
            padding: 1rem;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        .summary-box {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .summary-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body class="text-gray-700">

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-6">
            <h1 class="text-4xl font-bold text-gray-800">NSO Docket Dashboard</h1>
            <p class="text-gray-500 mt-1">Simplify and streamline store reviews.</p>
        </header>

        <div class="bg-white rounded-xl custom-shadow">
            <div id="main-nav-tabs" class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-8" aria-label="Tabs">
                    <button id="dashboard-tab-btn" class="main-tab-btn whitespace-nowrap py-4 px-1 font-bold text-base">Dashboard</button>
                    <button id="reviews-tab-btn" class="main-tab-btn whitespace-nowrap py-4 px-1 font-bold text-base">Reviews</button>
                </nav>
            </div>
            
            <div id="main-content-panels" class="p-6 sm:p-8">
                <div id="dashboard-panel">
                     <div class="mb-6 pb-6 border-b border-gray-200">
                        <div class="flex flex-wrap items-center gap-4">
                            <h2 class="text-xl font-bold text-gray-800">Filters:</h2>
                            <div>
                                <label for="filter-zone" class="sr-only">Filter by Zone</label>
                                <select id="filter-zone" class="form-select rounded-lg border-gray-300 shadow-sm">
                                    <option value="All">All Zones</option>
                                    <option>East</option>
                                    <option>Bihar</option>
                                    <option>South</option>
                                    <option>North</option>
                                    <option>UP</option>
                                </select>
                            </div>
                             <div>
                                <label for="filter-lead" class="sr-only">Filter by NSO Lead</label>
                                <select id="filter-lead" class="form-select rounded-lg border-gray-300 shadow-sm">
                                    <option value="All">All Leads</option>
                                </select>
                            </div>
                            <button id="download-summary-pdf-btn" class="btn-primary font-bold py-2 px-4 rounded-lg flex items-center ml-auto">
                                <i class="fas fa-download mr-2"></i> Download Summary
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-6">
                            <div class="bg-gray-50 p-6 rounded-lg text-center">
                                <p class="text-sm text-gray-500">Total Reviewed</p>
                                <p id="total-reviews-count" class="text-5xl font-bold text-indigo-600">0</p>
                            </div>
                            <div class="bg-gray-50 p-6 rounded-lg text-center">
                                <p class="text-sm text-gray-500">Done</p>
                                <p id="done-count" class="text-5xl font-bold text-green-600">0</p>
                            </div>
                             <div class="bg-gray-50 p-6 rounded-lg text-center">
                                <p class="text-sm text-gray-500">In Progress</p>
                                <p id="inprogress-count" class="text-5xl font-bold text-yellow-500">0</p>
                            </div>
                        </div>
                        <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div id="pending-summary-box" class="summary-box bg-yellow-50 p-6 rounded-lg">
                                <h3 class="font-bold text-yellow-800">Total Pending Points</h3>
                                <p id="total-pending-count" class="text-4xl font-bold text-yellow-600 mt-2">0</p>
                                <p class="text-xs text-yellow-700 mt-1">Click to see details</p>
                            </div>
                             <div id="na-summary-box" class="summary-box bg-gray-100 p-6 rounded-lg">
                                <h3 class="font-bold text-gray-800">Total N/A Points</h3>
                                <p id="total-na-count" class="text-4xl font-bold text-gray-600 mt-2">0</p>
                                <p class="text-xs text-gray-700 mt-1">Click to see details</p>
                            </div>
                        </div>
                        <div class="lg:col-span-3 bg-gray-50 p-6 rounded-lg">
                            <h3 class="font-bold text-gray-800 mb-4">Top 5 Pending Items</h3>
                            <canvas id="pending-items-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="reviews-panel" class="hidden">
                    <div class="mb-4">
                        <input type="text" id="storeNameInput" class="form-input w-full md:w-1/3 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Start a new review by store name...">
                    </div>
                     <div id="past-reviews-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                     </div>
                </div>
            </div>
            
             <div id="review-panel" class="p-6 sm:p-8 hidden">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <button id="back-to-dashboard-btn" class="text-gray-500 hover:text-indigo-600 font-bold flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i> Back
                    </button>
                    <h2 class="text-3xl font-bold text-gray-800">Review: <span id="activeStoreName" class="text-indigo-600"></span></h2>
                    <p class="text-sm text-gray-400 mt-1">User ID: <span id="userIdDisplay"></span></p>
                </div>
                
                <div id="review-checklist" class="space-y-5 max-h-[65vh] overflow-y-auto pr-3">
                </div>

                <div class="mt-8 flex justify-end space-x-4">
                     <button id="openPdfModalBtn" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-600 hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-150 ease-in-out flex items-center">
                        <i class="fas fa-file-pdf mr-2"></i> Download PDF
                    </button>
                    <button id="saveReviewBtn" class="bg-green-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-600 hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-150 ease-in-out flex items-center">
                        <i class="fas fa-check mr-2"></i> Save Review
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="notification-modal" class="modal fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 hidden z-50">
      <div class="relative w-full max-w-md p-6 border shadow-xl rounded-2xl bg-white fade-in">
        <div class="text-center">
          <div id="modal-icon" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4"></div>
          <h3 id="modal-title" class="text-xl leading-6 font-bold text-gray-900"></h3>
          <div class="mt-2 px-4 py-3"><p id="modal-message" class="text-sm text-gray-600"></p></div>
          <div class="mt-4"><button id="modal-close-btn" class="w-full btn-primary text-white text-base font-bold rounded-lg py-2.5 px-4 shadow-sm focus:outline-none">OK</button></div>
        </div>
      </div>
    </div>
    
    <div id="completion-summary-modal" class="modal fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 hidden z-50">
      <div class="relative w-full max-w-lg p-8 border shadow-xl rounded-2xl bg-white fade-in">
         <div class="text-center mb-4">
            <i class="fas fa-award fa-3x text-yellow-500"></i>
            <h3 class="text-2xl mt-2 leading-6 font-bold text-gray-900">Review Complete!</h3>
         </div>
          <div class="mt-4 bg-gray-50 p-4 rounded-lg">
             <h4 class="font-bold text-lg mb-2">Summary for: <span id="summary-store-name" class="text-indigo-600"></span></h4>
             <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <div id="summary-nso-lead" class="col-span-2"></div>
                <div id="summary-score" class="col-span-2"></div>
                <div id="summary-review-date"></div>
                <div id="summary-opening-date"></div>
             </dl>
          </div>
          <div class="mt-6 text-center"><button id="summary-modal-close-btn" class="btn-primary text-white text-base font-bold rounded-lg py-2.5 px-8 shadow-sm focus:outline-none">Close</button></div>
      </div>
    </div>

    <div id="details-modal" class="modal fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 hidden z-50">
      <div class="relative w-full max-w-2xl bg-white rounded-2xl shadow-xl fade-in">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 id="details-modal-title" class="text-xl font-bold text-gray-900"></h3>
            <button id="details-modal-close-btn" class="text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
        </div>
        <div id="details-modal-content" class="p-6 max-h-[70vh] overflow-y-auto"></div>
      </div>
    </div>

    <div id="pdf-options-modal" class="modal fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 hidden z-50">
      <div class="relative w-full max-w-md p-8 border shadow-xl rounded-2xl bg-white fade-in">
         <div class="text-center">
            <i class="fas fa-file-invoice text-3xl text-indigo-500 mb-4"></i>
            <h3 class="text-xl leading-6 font-bold text-gray-900">Choose PDF Report Type</h3>
            <p class="text-sm text-gray-500 mt-2">Select which version of the report you would like to download.</p>
         </div>
         <div class="mt-6 space-y-4">
            <button id="download-pending-pdf-btn" class="w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-600 transition-all">Download Pending Report</button>
            <button id="download-complete-pdf-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition-all">Download Complete Report</button>
         </div>
          <div class="mt-6 text-center">
            <button id="pdf-options-close-btn" class="text-gray-500 hover:text-gray-700 font-medium">Cancel</button>
          </div>
      </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const { jsPDF } = window.jspdf;

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO_KEY", authDomain: "DEMO.firebaseapp.com", projectId: "DEMO_PROJECT" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'nso-review-dashboard';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId = null;
        let reviewsCollectionRef = null;
        let currentReviewId = null;
        let allReviews = []; // Store all reviews for filtering
        let pendingItemsChart = null;
        let detailedPendingData = {};
        let detailedNaData = {};
        const nsoLeads = ["Jasbir", "Kshitij", "Amit.K", "Amit.S", "Rahul", "Lalit"];
        const zones = ["East", "Bihar", "South", "North", "UP"];

        const specialItemConfigs = {
            docketReviewDate: { type: 'date' },
            opening: { type: 'date' },
            actHoto: { type: 'date' },
            nsoLead: { type: 'dropdown', options: nsoLeads },
            zone: { type: 'dropdown', options: zones },
            checklistCurrentScore: { type: 'percentage' }
        };
        
        const checklistGroups = [
            { id: 'LICENSE', name: 'License' },
            { id: 'MAJOR_REPORTS', name: 'Major Reports' },
            { id: 'COMMISSIONING_REPORTS', name: 'Commissioning Reports' },
            { id: 'NSO_INITIATIVES', name: 'NSO Initiatives' },
        ];
        const checklistItems = [
            { id: 'docketReviewDate', text: 'Docket review date', group: 'top' },{ id: 'nsoLead', text: 'NSO Lead', group: 'top' }, { id: 'zone', text: 'Zone', group: 'top' }, { id: 'opening', text: 'Opening', group: 'top' },{ id: 'actHoto', text: 'ACT HOTO', group: 'top' },{ id: 'checklistCurrentScore', text: 'Checklist Current score', group: 'top' },{ id: 'fssaiLicences', text: 'FSSAI Licences', group: 'LICENSE' },{ id: 'tradeLicences', text: 'Trade Licences', group: 'LICENSE' },{ id: 'shopsEstablishmentLicense', text: 'Shops & Establishment License', group: 'LICENSE' },{ id: 'weighingMachineLicense', text: 'Weighing Machine License', group: 'LICENSE' },{ id: 'fireNoc', text: 'Fire NOC', group: 'LICENSE' },{ id: 'dgNoc', text: 'DG NOC', group: 'LICENSE' },{ id: 'generalInformation', text: 'General information', group: 'MAJOR_REPORTS' },{ id: 'loadSheet', text: 'Load sheet', group: 'MAJOR_REPORTS' },{ id: 'keyListHandover', text: 'Key list & handover', group: 'MAJOR_REPORTS' },{ id: 'vendorContactDetails', text: 'Vendor contact details', group: 'MAJOR_REPORTS' },{ id: 'snagList', text: 'Snag list', group: 'MAJOR_REPORTS' },{ id: 'excessMaterialList', text: 'Excess material list', group: 'MAJOR_REPORTS' },{ id: 'canteenItemList', text: 'Canteen item list', group: 'MAJOR_REPORTS' },{ id: 'hotoProjectNso', text: 'HOTO (project + nso)', group: 'MAJOR_REPORTS' },{ id: 'drawingIndex', text: 'Drawing index', group: 'MAJOR_REPORTS' },{ id: 'gfcSet', text: 'GFC set', group: 'MAJOR_REPORTS' },{ id: 'facadeDocket', text: 'Façade docket', group: 'MAJOR_REPORTS' },{ id: 'layoutPlan', text: 'Layout plan', group: 'MAJOR_REPORTS' },{ id: 'luxLevelReportOnLayout', text: 'Lux level report on layout', group: 'MAJOR_REPORTS' },{ id: 'cctvLayoutPlan', text: 'CCTV layout plan', group: 'MAJOR_REPORTS' },{ id: 'toiletHandover', text: 'Toilet handover', group: 'MAJOR_REPORTS' },{ id: 'dgAcTransformerLocationWithPhoto', text: 'DG, AC & Transformer location with photo', group: 'MAJOR_REPORTS' },{ id: 'odExpensesSheet', text: 'OD expenses sheet', group: 'MAJOR_REPORTS' },{ id: 'watercooler', text: 'Watercooler', group: 'COMMISSIONING_REPORTS' },{ id: 'sensormaticMachine', text: 'Sensormatic machine', group: 'COMMISSIONING_REPORTS' },{ id: 'dg', text: 'DG', group: 'COMMISSIONING_REPORTS' },{ id: 'ro', text: 'RO', group: 'COMMISSIONING_REPORTS' },{ id: 'paint', text: 'Paint', group: 'COMMISSIONING_REPORTS' },{ id: 'inverterLiftAirCutterSafe', text: 'Invertor, lift, air cutter safe', group: 'COMMISSIONING_REPORTS' },{ id: 'carpenter', text: 'Carpenter', group: 'COMMISSIONING_REPORTS' },{ id: 'falseCeiling', text: 'False ceiling', group: 'COMMISSIONING_REPORTS' },{ id: 'pestControl', text: 'Pest control', group: 'COMMISSIONING_REPORTS' },{ id: 'electric', text: 'Electric', group: 'COMMISSIONING_REPORTS' },{ id: 'ac', text: 'AC', group: 'COMMISSIONING_REPORTS' },{ id: 'marketingBoard', text: 'Marketing Board', group: 'COMMISSIONING_REPORTS' },{ id: 'camera', text: 'Camera', group: 'COMMISSIONING_REPORTS' },{ id: 'fireExtinguisher', text: 'Fire extinguisher', group: 'COMMISSIONING_REPORTS' },{ id: 'nsoInitiativePpt', text: 'NSO initiative PPT', group: 'NSO_INITIATIVES' },{ id: 'abstractFrame', text: 'Abstract frame', group: 'NSO_INITIATIVES' },{ id: 'staffBaggageRack', text: 'Staff baggage Rack', group: 'NSO_INITIATIVES' },{ id: 'hangerManagement', text: 'Hanger Management', group: 'NSO_INITIATIVES' },{ id: 'lightIdentification', text: 'Light identification', group: 'NSO_INITIATIVES' },{ id: 'drinkingWaterSignage', text: 'Drinking water signage', group: 'NSO_INITIATIVES' },{ id: 'glassTray', text: 'Glass & tray', group: 'NSO_INITIATIVES' },{ id: 'roWasteWaterManagement', text: 'RO waste water management', group: 'NSO_INITIATIVES' },{ id: 'sensorTagBox', text: 'Sensor tag box', group: 'NSO_INITIATIVES' },{ id: 'cameraIdentification', text: 'Camera identification', group: 'NSO_INITIATIVES' },{ id: 'electricityUssageGuidelines', text: 'Electricity usage guidelines', group: 'NSO_INITIATIVES' },{ id: 'whiteBoard', text: 'White board', group: 'NSO_INITIATIVES' },{ id: 'frostedVinyl', text: 'Frosted vinyl', group: 'NSO_INITIATIVES' },{ id: 'emptyBox', text: 'Empty Box', group: 'NSO_INITIATIVES' },{ id: 'backOfficeDrawerManagment', text: 'Back office drawer managment', group: 'NSO_INITIATIVES' },{ id: 'cashCounterDrawerManagment', text: 'Cash counter drawer managment', group: 'NSO_INITIATIVES' },{ id: 'cmsAgentPicDisplay', text: 'CMS Agent pic display', group: 'NSO_INITIATIVES' },{ id: 'layoutImplementation', text: 'Layout Implementation', group: 'NSO_INITIATIVES' },{ id: 'fireEscapeRoutePlan', text: 'Fire Escape route plan', group: 'NSO_INITIATIVES' },
        ];
        const getEl = (id) => document.getElementById(id);

        const showMainContent = (show) => {
            getEl('main-nav-tabs').classList.toggle('hidden', !show);
            getEl('main-content-panels').classList.toggle('hidden', !show);
        };
        
        const showReviewPanel = (show) => {
            getEl('review-panel').classList.toggle('hidden', !show);
            showMainContent(!show);
            if (!show) currentReviewId = null;
        };
        
        const createChecklistItemHTML = (item, reviewData) => {
            const config = specialItemConfigs[item.id];
            const existingItem = reviewData?.reviewItems.find(ri => ri.id === item.id);
            let inputHtml = '';
            switch (config?.type) {
                case 'date':
                    inputHtml = `<input type="date" id="value-${item.id}" value="${existingItem?.value || ''}" class="form-input mt-2 block w-full sm:w-1/2 px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm">`; break;
                case 'percentage':
                    inputHtml = `<div class="relative mt-2 sm:w-1/2"><input type="number" id="value-${item.id}" value="${existingItem?.value || ''}" class="form-input block w-full pl-3 pr-8 py-2 bg-white border border-gray-300 rounded-lg shadow-sm" placeholder="e.g., 85"><div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><span class="text-gray-500">%</span></div></div>`; break;
                case 'dropdown':
                    const selectedValue = existingItem?.value || '';
                    const optionsHtml = config.options.map(opt => `<option value="${opt}" ${selectedValue === opt ? 'selected' : ''}>${opt}</option>`).join('');
                    const otherValue = config.options.includes(selectedValue) ? '' : selectedValue;
                    inputHtml = `<div class="mt-2 sm:w-1/2 space-y-2"><select id="value-${item.id}" class="form-select block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm"><option value="">Select an option...</option>${optionsHtml}${item.id === 'nsoLead' ? '<option value="Other">Other...</option>' : ''}</select><input type="text" id="value-${item.id}-other" value="${otherValue}" class="form-input block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm ${!selectedValue || config.options.includes(selectedValue) ? 'hidden' : ''}" placeholder="Please specify"></div>`; break;
                default:
                    const status = existingItem?.status || 'Pending';
                    inputHtml = `<div class="mt-2 flex flex-col sm:flex-row gap-4 items-start"><div class="flex-shrink-0 flex items-center space-x-4 pt-1"><label class="inline-flex items-center"><input type="radio" name="status-${item.id}" value="Done" class="form-radio h-4 w-4 text-green-600" ${status === 'Done' ? 'checked' : ''}><span class="ml-2 text-sm font-medium text-green-700">Done</span></label><label class="inline-flex items-center"><input type="radio" name="status-${item.id}" value="Pending" class="form-radio h-4 w-4 text-yellow-500" ${status === 'Pending' ? 'checked' : ''}><span class="ml-2 text-sm font-medium text-yellow-600">Pending</span></label><label class="inline-flex items-center"><input type="radio" name="status-${item.id}" value="N/A" class="form-radio h-4 w-4 text-gray-500" ${status === 'N/A' ? 'checked' : ''}><span class="ml-2 text-sm font-medium text-gray-600">N/A</span></label></div><input type="text" id="remarks-${item.id}" class="form-input mt-1 sm:mt-0 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm text-sm" placeholder="Remarks (optional)" value="${existingItem?.remarks || ''}"></div>`; break;
            }
            return `<div class="p-4 border-t border-gray-100 first:border-t-0"><label for="value-${item.id}" class="block text-md font-bold text-gray-800">${item.text}</label>${inputHtml}</div>`;
        };
        const populateChecklist = (reviewData = null) => {
            const checklistContainer = getEl('review-checklist');
            checklistContainer.innerHTML = '';
            checklistItems.filter(item => item.group === 'top').forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.innerHTML = createChecklistItemHTML(item, reviewData);
                checklistContainer.appendChild(itemEl.firstChild);
            });
            checklistGroups.forEach(group => {
                const groupItems = checklistItems.filter(item => item.group === group.id);
                if (groupItems.length === 0) return;
                const detailsEl = document.createElement('details');
                const summaryEl = document.createElement('summary');
                summaryEl.textContent = group.name;
                const contentDiv = document.createElement('div');
                contentDiv.className = 'accordion-content space-y-0 divide-y divide-gray-100';
                groupItems.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.innerHTML = createChecklistItemHTML(item, reviewData);
                    contentDiv.appendChild(itemEl.firstChild);
                });
                detailsEl.appendChild(summaryEl);
                detailsEl.appendChild(contentDiv);
                checklistContainer.appendChild(detailsEl);
            });
            checklistItems.filter(item => specialItemConfigs[item.id]?.type === 'dropdown' && item.id === 'nsoLead').forEach(item => {
                const selectEl = getEl(`value-${item.id}`);
                const otherInputEl = getEl(`value-${item.id}-other`);
                if (selectEl && otherInputEl) {
                    selectEl.addEventListener('change', () => otherInputEl.classList.toggle('hidden', selectEl.value !== 'Other'));
                }
            });
        };
        const showNotification = (type, title, message) => {
            const modalIconContainer = getEl('modal-icon');
            modalIconContainer.innerHTML = type === 'success' ? `<i class="fas fa-check fa-2x text-green-500"></i>` : `<i class="fas fa-exclamation-triangle fa-2x text-red-500"></i>`;
            modalIconContainer.className = `mx-auto flex items-center justify-center h-16 w-16 rounded-full ${type === 'success' ? 'bg-green-100' : 'bg-red-100'} mb-4`;
            getEl('modal-title').textContent = title;
            getEl('modal-message').textContent = message;
            getEl('notification-modal').classList.remove('hidden');
        };
        const showCompletionSummary = (reviewData) => {
            getEl('summary-store-name').textContent = reviewData.storeName;
            const findValue = (id) => reviewData.reviewItems.find(item => item.id === id)?.value || 'N/A';
            getEl('summary-nso-lead').innerHTML = `<dt class="font-medium text-gray-500">NSO Lead</dt><dd class="text-gray-900 font-semibold">${findValue('nsoLead')}</dd>`;
            getEl('summary-score').innerHTML = `<dt class="font-medium text-gray-500">Final Score</dt><dd class="text-gray-900 font-semibold">${findValue('checklistCurrentScore') ? findValue('checklistCurrentScore') + '%' : 'N/A'}</dd>`;
            getEl('summary-review-date').innerHTML = `<dt class="font-medium text-gray-500">Review Date</dt><dd class="text-gray-900 font-semibold">${findValue('docketReviewDate')}</dd>`;
            getEl('summary-opening-date').innerHTML = `<dt class="font-medium text-gray-500">Opening Date</dt><dd class="text-gray-900 font-semibold">${findValue('opening')}</dd>`;
            getEl('completion-summary-modal').classList.remove('hidden');
        };

        const showDetailsModal = (type, data) => {
            const modal = getEl('details-modal');
            const titleEl = getEl('details-modal-title');
            const contentEl = getEl('details-modal-content');
            
            titleEl.textContent = `Detailed ${type} View`;
            contentEl.innerHTML = '';

            if (Object.keys(data).length === 0) {
                contentEl.innerHTML = `<p class="text-gray-500 text-center">No ${type.toLowerCase()} items found.</p>`;
            } else {
                for (const storeName in data) {
                    const storeDiv = document.createElement('div');
                    storeDiv.className = 'mb-4';
                    storeDiv.innerHTML = `<h4 class="font-bold text-lg text-indigo-600">${storeName}</h4>
                                          <ul class="list-disc list-inside text-gray-700 mt-1">
                                            ${data[storeName].map(item => `<li>${item}</li>`).join('')}
                                          </ul>`;
                    contentEl.appendChild(storeDiv);
                }
            }
            modal.classList.remove('hidden');
        };

        const generateSingleReviewPdf = async (reportType = 'complete') => {
            getEl('pdf-options-modal').classList.add('hidden');
            if (!currentReviewId) {
                showNotification('error', 'PDF Error', 'Please save the review before downloading the PDF.');
                return;
            }
            const docRef = doc(reviewsCollectionRef, currentReviewId);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) {
                showNotification('error', 'PDF Error', 'Could not find review data.');
                return;
            }
            const reviewData = docSnap.data();
            const { storeName, reviewItems } = reviewData;
            const docPDF = new jsPDF();
            docPDF.setFontSize(22);
            docPDF.text(`NSO Docket Review (${reportType.charAt(0).toUpperCase() + reportType.slice(1)})`, 105, 20, { align: 'center' });
            docPDF.setFontSize(16);
            docPDF.text(`Store: ${storeName}`, 105, 30, { align: 'center' });
            
            const findValue = (id) => reviewItems.find(item => item.id === id)?.value || 'N/A';
            const summaryData = [
                ['Docket Review Date', findValue('docketReviewDate')],['NSO Lead', findValue('nsoLead')],['Zone', findValue('zone')],['Opening Date', findValue('opening')],['ACT HOTO Date', findValue('actHoto')],['Checklist Score', findValue('checklistCurrentScore') ? `${findValue('checklistCurrentScore')}%` : 'N/A'],
            ];
            docPDF.autoTable({ startY: 40, head: [['Parameter', 'Details']], body: summaryData, theme: 'striped', headStyles: { fillColor: [79, 70, 229] } });

            let tableBody = [];
            const itemsToInclude = reportType === 'pending' ? reviewItems.filter(item => item.status === 'Pending') : reviewItems;
            checklistGroups.forEach(group => {
                const groupItems = itemsToInclude.filter(item => item.group === group.id);
                if (groupItems.length > 0) {
                    tableBody.push([{ content: group.name, colSpan: 3, styles: { fontStyle: 'bold', fillColor: '#f3f4f6', textColor: '#111827' } }]);
                    groupItems.forEach(item => tableBody.push([item.text, item.status || '-', item.remarks || '-']));
                }
            });

            docPDF.autoTable({
                startY: docPDF.autoTable.previous.finalY + 10, head: [['Checklist Item', 'Status', 'Remarks']], body: tableBody, theme: 'grid', headStyles: { fillColor: [79, 70, 229] },
                didParseCell: (data) => {
                    if (data.column.index === 1 && data.cell.section === 'body') {
                        switch(data.cell.raw) {
                            case 'Done': data.cell.styles.textColor = [34, 197, 94]; data.cell.styles.fontStyle = 'bold'; break;
                            case 'Pending': data.cell.styles.textColor = [234, 179, 8]; data.cell.styles.fontStyle = 'bold'; break;
                        }
                    }
                }
            });
            docPDF.save(`Review-${storeName}-${reportType}.pdf`);
        };
        
        const generateSummaryPdf = async () => {
            const selectedZone = getEl('filter-zone').value;
            const selectedLead = getEl('filter-lead').value;
            const filteredReviews = allReviews.filter(review => {
                const findValue = (id) => review.reviewItems.find(item => item.id === id)?.value;
                const zoneMatch = selectedZone === 'All' || findValue('zone') === selectedZone;
                const leadMatch = selectedLead === 'All' || findValue('nsoLead') === selectedLead;
                return zoneMatch && leadMatch;
            });
            if (filteredReviews.length === 0) { showNotification('error', 'No Data', 'No reviews found for the selected filters.'); return; }
            const docPDF = new jsPDF();
            docPDF.setFontSize(22); docPDF.text("NSO Docket Summary Report", 105, 20, { align: 'center' });
            docPDF.setFontSize(12); docPDF.text(`Filters - Zone: ${selectedZone}, Lead: ${selectedLead}`, 105, 30, { align: 'center' });
            let finalY = 40;
            for (const review of filteredReviews) {
                const { storeName, reviewItems } = review;
                if (finalY > 40) finalY += 10;
                if (finalY > 260) { docPDF.addPage(); finalY = 20; }
                docPDF.setFontSize(14); docPDF.text(storeName, 14, finalY); finalY += 5;
                let tableBody = [];
                checklistGroups.forEach(group => {
                    const groupItems = reviewItems.filter(item => item.group === group.id && (item.status === 'Done' || item.status === 'Pending'));
                    if (groupItems.length > 0) {
                        tableBody.push([{ content: group.name, colSpan: 2, styles: { fontStyle: 'bold', fillColor: '#f3f4f6', textColor: '#111827' } }]);
                        groupItems.forEach(item => tableBody.push([item.text, item.status]));
                    }
                });
                docPDF.autoTable({
                    startY: finalY, head: [['Checklist Item', 'Status']], body: tableBody, theme: 'grid', headStyles: { fillColor: [79, 70, 229] },
                    didParseCell: (data) => {
                        if (data.column.index === 1 && data.cell.section === 'body') {
                            switch(data.cell.raw) {
                                case 'Done': data.cell.styles.textColor = [34, 197, 94]; data.cell.styles.fontStyle = 'bold'; break;
                                case 'Pending': data.cell.styles.textColor = [234, 179, 8]; data.cell.styles.fontStyle = 'bold'; break;
                            }
                        }
                    }
                });
                finalY = docPDF.autoTable.previous.finalY;
            }
            docPDF.save(`Summary-Report-${selectedZone}-${selectedLead}.pdf`);
        };


        const saveReview = async () => {
            if (!userId) { showNotification('error', 'Error', 'User not authenticated.'); return; }
            const storeName = getEl('activeStoreName').textContent;
            const docId = currentReviewId || `${storeName.replace(/\s+/g, '-')}-${Date.now()}`;
            currentReviewId = docId;

            const reviewData = {
                userId, storeName, createdAt: serverTimestamp(),
                reviewItems: checklistItems.map(item => {
                    const config = specialItemConfigs[item.id];
                    const baseData = { id: item.id, text: item.text, group: item.group };
                    switch (config?.type) {
                        case 'date': case 'percentage': 
                            const valEl = getEl(`value-${item.id}`);
                            return { ...baseData, type: config.type, value: valEl ? valEl.value : '' };
                        case 'dropdown': 
                            let value = getEl(`value-${item.id}`).value; 
                            if (value === 'Other') value = getEl(`value-${item.id}-other`).value.trim(); 
                            return { ...baseData, type: 'dropdown', value };
                        default: 
                            const statusEl = document.querySelector(`input[name="status-${item.id}"]:checked`);
                            const remarksEl = getEl(`remarks-${item.id}`);
                            return { ...baseData, type: 'status', status: statusEl ? statusEl.value : 'Pending', remarks: remarksEl ? remarksEl.value.trim() : '' };
                    }
                })
            };
            const saveBtn = getEl('saveReviewBtn');
            saveBtn.disabled = true; saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            try {
                await setDoc(doc(reviewsCollectionRef, docId), reviewData);
                showNotification('success', 'Success!', 'Review saved. You can now download the PDF.');
                const isComplete = !reviewData.reviewItems.some(item => item.status === 'Pending');
                if (isComplete) showCompletionSummary(reviewData);
            } catch (error) {
                showNotification('error', 'Save Error', 'There was a problem saving the review.'); console.error("Error saving review: ", error);
            } finally {
                saveBtn.disabled = false; saveBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Save Review';
            }
        };

        const renderPendingItemsChart = (pendingItemsCount) => {
            const ctx = getEl('pending-items-chart').getContext('2d');
            const sortedPending = Object.entries(pendingItemsCount).sort(([,a],[,b]) => b-a).slice(0, 5);
            
            const labels = sortedPending.map(([text]) => text.length > 25 ? text.substring(0, 22) + '...' : text);
            const data = sortedPending.map(([,count]) => count);

            if (pendingItemsChart) pendingItemsChart.destroy();
            pendingItemsChart = new Chart(ctx, {
                type: 'bar', data: { labels: labels, datasets: [{ label: '# of Pending Reviews', data: data, backgroundColor: 'rgba(245, 158, 11, 0.6)', borderColor: 'rgba(245, 158, 11, 1)', borderWidth: 1 }] },
                options: { indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
            });
        };
        
        const updateDashboardSummary = () => {
            const selectedZone = getEl('filter-zone').value;
            const selectedLead = getEl('filter-lead').value;

            const filteredReviews = allReviews.filter(review => {
                const findValue = (id) => review.reviewItems.find(item => item.id === id)?.value;
                const zoneMatch = selectedZone === 'All' || findValue('zone') === selectedZone;
                const leadMatch = selectedLead === 'All' || findValue('nsoLead') === selectedLead;
                return zoneMatch && leadMatch;
            });

            let pendingItemsCount = {}; let naItemsCount = {}; let doneCount = 0; let inProgressCount = 0;
            detailedPendingData = {}; detailedNaData = {};
            
            filteredReviews.forEach(review => {
                const hasPending = review.reviewItems?.some(item => item.status === 'Pending');
                if (hasPending) { inProgressCount++; } else { doneCount++; }
                
                review.reviewItems?.forEach(item => {
                    if (item.status === 'Pending') {
                        pendingItemsCount[item.text] = (pendingItemsCount[item.text] || 0) + 1;
                        if (!detailedPendingData[review.storeName]) detailedPendingData[review.storeName] = [];
                        detailedPendingData[review.storeName].push(item.text);
                    }
                    if (item.status === 'N/A') {
                        naItemsCount[item.text] = (naItemsCount[item.text] || 0) + 1;
                         if (!detailedNaData[review.storeName]) detailedNaData[review.storeName] = [];
                        detailedNaData[review.storeName].push(item.text);
                    }
                });
            });

            getEl('total-reviews-count').textContent = filteredReviews.length;
            getEl('done-count').textContent = doneCount;
            getEl('inprogress-count').textContent = inProgressCount;
            getEl('total-pending-count').textContent = Object.values(pendingItemsCount).reduce((a, b) => a + b, 0);
            getEl('total-na-count').textContent = Object.values(naItemsCount).reduce((a, b) => a + b, 0);
            renderPendingItemsChart(pendingItemsCount);
        }

        const fetchAndDisplayReviews = () => {
            if (!reviewsCollectionRef) return;
            onSnapshot(query(reviewsCollectionRef), (snapshot) => {
                allReviews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const leadFilter = getEl('filter-lead');
                const uniqueLeads = [...new Set(allReviews.map(r => r.reviewItems.find(i => i.id === 'nsoLead')?.value).filter(Boolean))];
                leadFilter.innerHTML = '<option value="All">All Leads</option>';
                uniqueLeads.sort().forEach(lead => {
                    const option = document.createElement('option');
                    option.value = lead;
                    option.textContent = lead;
                    leadFilter.appendChild(option);
                });

                updateDashboardSummary();
                
                const pastReviewsContainer = getEl('past-reviews-container');
                pastReviewsContainer.innerHTML = '';
                if(allReviews.length === 0) {
                    pastReviewsContainer.innerHTML = `<p class="text-gray-500 text-center py-4 md:col-span-2 lg:col-span-3">No past reviews found.</p>`;
                } else {
                    allReviews.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0)).forEach(review => {
                        const isComplete = !review.reviewItems?.some(item => item.status === 'Pending');
                        const el = document.createElement('div');
                        el.className = `review-item border-l-4 p-4 rounded-lg custom-shadow cursor-pointer transition-all ${isComplete ? 'review-complete' : 'review-in-progress'}`;
                        el.innerHTML = `<div class="flex justify-between items-center"><p class="review-store-name font-bold text-lg">${review.storeName}</p><i class="review-status-icon fas ${isComplete ? 'fa-check-circle text-green-500' : 'fa-hourglass-half text-yellow-500'}"></i></div><p class="text-xs text-gray-500 mt-1">Reviewed on: ${review.createdAt ? review.createdAt.toDate().toLocaleDateString('en-IN') : 'N/A'}</p>`;
                        el.addEventListener('click', async () => {
                            const docSnap = await getDoc(doc(reviewsCollectionRef, review.id));
                            if (docSnap.exists()) {
                                currentReviewId = review.id;
                                getEl('activeStoreName').textContent = docSnap.data().storeName;
                                populateChecklist(docSnap.data());
                                showReviewPanel(true);
                            }
                        });
                        pastReviewsContainer.appendChild(el);
                    });
                }
            });
        };

        const switchTab = (target) => {
            getEl('dashboard-tab-btn').classList.toggle('active', target === 'dashboard');
            getEl('reviews-tab-btn').classList.toggle('active', target === 'reviews');
            getEl('dashboard-panel').classList.toggle('hidden', target !== 'dashboard');
            getEl('reviews-panel').classList.toggle('hidden', target !== 'reviews');
        };

        const startNewReviewFromInput = () => {
             const storeName = getEl('storeNameInput').value.trim();
            if (!storeName) { showNotification('error', 'Input Error', 'Please enter a store name.'); return; }
            currentReviewId = null;
            getEl('activeStoreName').textContent = storeName;
            populateChecklist();
            showReviewPanel(true);
            getEl('storeNameInput').value = '';
        }

        getEl('storeNameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startNewReviewFromInput();
        });
        
        getEl('back-to-dashboard-btn').addEventListener('click', () => showReviewPanel(false));
        getEl('saveReviewBtn').addEventListener('click', saveReview);
        getEl('openPdfModalBtn').addEventListener('click', () => getEl('pdf-options-modal').classList.remove('hidden'));
        getEl('pdf-options-close-btn').addEventListener('click', () => getEl('pdf-options-modal').classList.add('hidden'));
        getEl('download-pending-pdf-btn').addEventListener('click', () => generateSingleReviewPdf('pending'));
        getEl('download-complete-pdf-btn').addEventListener('click', () => generateSingleReviewPdf('complete'));
        getEl('download-summary-pdf-btn').addEventListener('click', generateSummaryPdf);
        getEl('modal-close-btn').addEventListener('click', () => getEl('notification-modal').classList.add('hidden'));
        getEl('summary-modal-close-btn').addEventListener('click', () => getEl('completion-summary-modal').classList.add('hidden'));
        getEl('details-modal-close-btn').addEventListener('click', () => getEl('details-modal').classList.add('hidden'));
        getEl('dashboard-tab-btn').addEventListener('click', () => switchTab('dashboard'));
        getEl('reviews-tab-btn').addEventListener('click', () => switchTab('reviews'));
        getEl('pending-summary-box').addEventListener('click', () => showDetailsModal('Pending', detailedPendingData));
        getEl('na-summary-box').addEventListener('click', () => showDetailsModal('N/A', detailedNaData));
        getEl('filter-zone').addEventListener('change', updateDashboardSummary);
        getEl('filter-lead').addEventListener('change', updateDashboardSummary);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                getEl('userIdDisplay').textContent = userId;
                reviewsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/reviews`);
                fetchAndDisplayReviews();
            } else {
                try {
                     if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); }
                } catch (error) { console.error("Authentication error:", error); }
            }
        });
        
        switchTab('dashboard');
    </script>
</body>
</html>
